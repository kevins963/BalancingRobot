#ifndef ROBOT_CORE_LSM303D_H_
#define ROBOT_CORE_LSM303D_H_

#include "robot/core/i2c_dev.h"
#include "robot/core/integer.h"
#include "robot/core/util.h"

#define LSM303D_DEVICE_ADDR (0x3A)

#define LSM303D_RA_TEMP_OUT_L 0x05
#define LSM303D_RA_TEMP_OUT_H 0x06
#define LSM303D_RA_STATUS_M 0x07
#define LSM303D_RA_OUT_X_L_M 0x08
#define LSM303D_RA_OUT_X_H_M 0x09
#define LSM303D_RA_OUT_Y_L_M 0x0A
#define LSM303D_RA_OUT_Y_H_M 0x0B
#define LSM303D_RA_OUT_Z_L_M 0x0C
#define LSM303D_RA_OUT_Z_H_M 0x0D
#define LSM303D_RA_WHO_AM_I_ADDR 0x0F

#define LSM303D_RA_INT_CTRL_M 0x12
#define LSM303D_RA_INT_SRC_M 0x13
#define LSM303D_RA_INT_THS_L_M 0x14
#define LSM303D_RA_INT_THS_H_M 0x15
#define LSM303D_RA_OFFSET_X_L_M 0x16
#define LSM303D_RA_OFFSET_X_H_M 0x17
#define LSM303D_RA_OFFSET_Y_L_M 0x18
#define LSM303D_RA_OFFSET_Y_H_M 0x19
#define LSM303D_RA_OFFSET_Z_L_M 0x1A
#define LSM303D_RA_OFFSET_Z_H_M 0x1B
#define LSM303D_RA_REF_X 0x1C
#define LSM303D_RA_REF_Y 0x1D
#define LSM303D_RA_REF_Z 0x1E
#define LSM303D_RA_CTRL0 0x1F
#define LSM303D_RA_CTRL1 0x20
#define LSM303D_RA_CTRL2 0x21
#define LSM303D_RA_CTRL3 0x22
#define LSM303D_RA_CTRL4 0x23
#define LSM303D_RA_CTRL5 0x24
#define LSM303D_RA_CTRL6 0x25
#define LSM303D_RA_CTRL7 0x26
#define LSM303D_RA_STATUS_A 0x27
#define LSM303D_RA_OUT_X_L_A 0x28
#define LSM303D_RA_OUT_X_H_A 0x29
#define LSM303D_RA_OUT_Y_L_A 0x2A
#define LSM303D_RA_OUT_Y_H_A 0x2B
#define LSM303D_RA_OUT_Z_L_A 0x2C
#define LSM303D_RA_OUT_Z_H_A 0x2D
#define LSM303D_RA_FIFO_CTRL 0x2E
#define LSM303D_RA_FIFO_SRC 0x2F
#define LSM303D_RA_IG_CFG1 0x30
#define LSM303D_RA_IG_SRC1 0x31
#define LSM303D_RA_IC_THS1 0x32
#define LSM303D_RA_IC_DUR1 0x33
#define LSM303D_RA_IC_CFG2 0x34
#define LSM303D_RA_IC_SRC2 0x35
#define LSM303D_RA_IC_THS2 0x36
#define LSM303D_RA_IC_DUR2 0x37
#define LSM303D_RA_CLICK_CFG 0x38
#define LSM303D_RA_CLICK_SRC 0x39
#define LSM303D_RA_CLICK_THS 0x3A
#define LSM303D_RA_TIME_LIMIT 0x3B
#define LSM303D_RA_TIME_LATENCY 0x3C
#define LSM303D_RA_TIME_WINDOW 0x3D
#define LSM303D_RA_ACT_THS 0x3E
#define LSM303D_RA_ACT_DUR 0x3F

#define LSM303D_RA_MAX_REGISTERS (0x40)

#define LSM303D_VAL_CTRL0_HPINT_2 MASKED_VALUE(1, BIT_POS_0, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL0_HPINT_1 MASKED_VALUE(1, BIT_POS_1, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL0_HP_CLICK MASKED_VALUE(1, BIT_POS_2, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL0_FTH_EN MASKED_VALUE(1, BIT_POS_5, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL0_FIFO_EN MASKED_VALUE(1, BIT_POS_6, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL0_BOOT MASKED_VALUE(1, BIT_POS_7, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL1_X_EN MASKED_VALUE(1, BIT_POS_0, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL1_Y_EN MASKED_VALUE(1, BIT_POS_1, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL1_Z_EN MASKED_VALUE(1, BIT_POS_2, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL1_BLOCK_UPDATE \
  MASKED_VALUE(1, BIT_POS_3, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL1_ODR_PD MASKED_VALUE(0, BIT_POS_4, BIT_MASK_SIZE_4
#define LSM303D_VAL_CTRL1_ODR_3_125 MASKED_VALUE(1, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_6_25 MASKED_VALUE(2, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_12_5 MASKED_VALUE(3, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_25 MASKED_VALUE(4, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_50 MASKED_VALUE(5, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_100 MASKED_VALUE(6, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_200 MASKED_VALUE(7, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_400 MASKED_VALUE(8, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_800 MASKED_VALUE(9, BIT_POS_4, BIT_MASK_SIZE_4)
#define LSM303D_VAL_CTRL1_ODR_1600 MASKED_VALUE(10, BIT_POS_4, BIT_MASK_SIZE_4)

#define LSM303D_VAL_CTRL2_SPI_4 MASKED_VALUE(0, BIT_POS_0, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL2_SPI_3 MASKED_VALUE(1, BIT_POS_0, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL2_SELF_TEST_ENABLED \
  MASKED_VALUE(1, BIT_POS_1, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL2_SCALE_2G MASKED_VALUE(0, BIT_POS_3, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL2_SCALE_4G MASKED_VALUE(1, BIT_POS_3, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL2_SCALE_6G MASKED_VALUE(2, BIT_POS_3, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL2_SCALE_8G MASKED_VALUE(3, BIT_POS_3, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL2_SCALE_16G MASKED_VALUE(4, BIT_POS_3, BIT_MASK_SIZE_3)

#define LSM303D_VAL_CTRL2_BW_773HZ MASKED_VALUE(0, BIT_POS_6, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL2_BW_194HZ MASKED_VALUE(1, BIT_POS_6, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL2_BW_362HZ MASKED_VALUE(2, BIT_POS_6, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL2_BW_50HZ MASKED_VALUE(3, BIT_POS_6, BIT_MASK_SIZE_2)

#define LSM303D_VAL_CTRL3_INT1_FIFO_EMPTY \
  MASKED_VALUE(1, BIT_POS_0, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL3_INT1_DATA_M_READY \
  MASKED_VALUE(1, BIT_POS_1, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL3_INT1_DATA_A_READY \
  MASKED_VALUE(1, BIT_POS_2, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL3_INT1_MAG MASKED_VALUE(1, BIT_POS_3, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL3_INT1_INERTIA_2 \
  MASKED_VALUE(1, BIT_POS_4, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL3_INT1_INERTIA_1 \
  MASKED_VALUE(1, BIT_POS_5, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL3_INT1_CLICK MASKED_VALUE(1, BIT_POS_6, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL3_INT1_BOOT MASKED_VALUE(1, BIT_POS_7, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL4_INT2_FTH MASKED_VALUE(1, BIT_POS_0, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL4_INT2_OVERRUN \
  MASKED_VALUE(1, BIT_POS_1, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL4_INT2_DATA_M_READY \
  MASKED_VALUE(1, BIT_POS_2, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL4_INT2_DATA_A_READY \
  MASKED_VALUE(1, BIT_POS_3, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL4_INT2_MAG MASKED_VALUE(1, BIT_POS_4, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL4_INT2_INERTIA_2 \
  MASKED_VALUE(1, BIT_POS_5, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL4_INT2_INERTIA_1 \
  MASKED_VALUE(1, BIT_POS_6, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL4_INT2_CLICK MASKED_VALUE(1, BIT_POS_7, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL5_INT1_LATCHED \
  MASKED_VALUE(1, BIT_POS_0, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL5_INT2_LATCHED \
  MASKED_VALUE(1, BIT_POS_1, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL5_M_ODR_3_125HZ \
  MASKED_VALUE(0, BIT_POS_2, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL5_M_ODR_6_25HZ \
  MASKED_VALUE(1, BIT_POS_2, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL5_M_ODR_12_5HZ \
  MASKED_VALUE(2, BIT_POS_2, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL5_M_ODR_25HZ MASKED_VALUE(3, BIT_POS_2, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL5_M_ODR_50HZ MASKED_VALUE(4, BIT_POS_2, BIT_MASK_SIZE_3)
#define LSM303D_VAL_CTRL5_M_ODR_100HZ \
  MASKED_VALUE(5, BIT_POS_2, BIT_MASK_SIZE_3)

#define LSM303D_VAL_CTRL5_M_RES_LOW MASKED_VALUE(0, BIT_POS_5, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL5_M_RES_HIGH \
  MASKED_VALUE(0x03, BIT_POS_5, BIT_MASK_SIZE_2)

#define LSM303D_VAL_CTRL5_TEMP_ENABLED \
  MASKED_VALUE(1, BIT_POS_7, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL6_M_SCALE_2G MASKED_VALUE(0, BIT_POS_5, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL6_M_SCALE_4G MASKED_VALUE(1, BIT_POS_5, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL6_M_SCALE_8G MASKED_VALUE(2, BIT_POS_5, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL6_M_SCALE_12G \
  MASKED_VALUE(3, BIT_POS_5, BIT_MASK_SIZE_2)

#define LSM303D_VAL_CTRL7_M_MODE_CONT \
  MASKED_VALUE(0, BIT_POS_0, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL7_M_MODE_SINGLE \
  MASKED_VALUE(1, BIT_POS_0, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL7_M_MODE_PD MASKED_VALUE(2, BIT_POS_0, BIT_MASK_SIZE_2)

#define LSM303D_VAL_CTRL7_M_LOW_POWER_MODE \
  MASKED_VALUE(1, BIT_POS_2, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL7_T_ONLY MASKED_VALUE(1, BIT_POS_4, BIT_MASK_SIZE_1)
#define LSM303D_VAL_CTRL7_A_DATA_OUT_FILTERED \
  MASKED_VALUE(1, BIT_POS_5, BIT_MASK_SIZE_1)

#define LSM303D_VAL_CTRL7_A_HPF_MODE_NORMAL \
  MASKED_VALUE(0, BIT_POS_6, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL7_A_HPF_MODE_REF \
  MASKED_VALUE(1, BIT_POS_6, BIT_MASK_SIZE_2)
#define LSM303D_VAL_CTRL7_A_HPF_MODE_AUTO_RESET \
  MASKED_VALUE(3, BIT_POS_6, BIT_MASK_SIZE_2)

#define LSM303D_SENSITIVITY_2G (0.000061F)
#define LSM303D_SENSITIVITY_4G (0.000112F)
#define LSM303D_SENSITIVITY_8G (0.000183F)
#define LSM303D_SENSITIVITY_16G (0.000732F)

BEGIN_STRUCT(AccelData)
float x;
float y;
float z;
END_STRUCT(AccelData)

BEGIN_STRUCT(LSM303D)
I2CDev i2c_dev;
uint8_t device_address;
uint8_t read_buf[LSM303D_RA_MAX_REGISTERS];
uint8_t write_buf[LSM303D_RA_MAX_REGISTERS];
AccelData accel_data;
END_STRUCT(LSM303D)

void LSM303D_Init(LSM303D* p_this, const I2cFunctions* i2c_functions);
void LSM303D_Start(LSM303D* p_this);
void LSM303D_ReadAll(LSM303D* p_this);
void LSM303D_ReadWhoAmI(LSM303D* p_this);
void LSM303D_ReadAccel(LSM303D* p_this);
void LSM303D_OnComplete(LSM303D* p_this);

#endif  // ROBOT_CORE_LSM303D_H_
